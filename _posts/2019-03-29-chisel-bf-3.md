---
layout: post
title: "ChiselでBF処理系を作る(3)"
date: 2019-03-29
description: 'FIFOの実装'
main-class: 'jekyll'
image: 
color: '#B31917'
tags:
- scala
- FPGA
- Chisel
- Brainf**k
categories:
draft: true
---

[前回は](https://kamiyaowl.github.io/blog/chisel-bf-2/)ボタン入力のチャタリング回路実装を行った。次は各モジュールをつなぐFIFOを実装する。


<div class="mermaid">
graph LR
    PC -- USB --- USB_Uart
    USB_Uart --Tx--> UartTxRx
    UartTxRx--Rx--> USB_Uart
    UartTxRx -- program/stdin -->FIFO_din
    FIFO_din -- program --> BF_Processor
    FIFO_din -- stdin--> BF_Processor
    BF_Processor -- stdout --> FIFO_dout
    FIFO_dout -- stdout --> UartTxRx
    External_SW --program/run -->UntiChatter
    UntiChatter -->BF_Processor
    style FIFO_din fill:#f66,stroke:#f33
    style FIFO_dout fill:#f66,stroke:#f33
</div>

## FIFOの実装方法

### I/Fの方式

今回はReady/Valid/Ackの予備チャネルを備えたオレオレストリームインターフェースでやり取りする。

(一般的にはDestinationからreadyが出ていたらデータを流し続けてstart/endなどでフラグを立てるようなものが多い印象。今回のI/Fは作ってから思ったがAckはReadyと機能がかぶっていて、帯域を落とすだけで冗長だったと反省している)

ともあれ処理のフローは以下の通りである。

<div class="mermaid">
sequenceDiagram
  participant Source
  participant Destination
  loop Source not empty
    Source-->>+Destination: Ready?
    note right of Destination: Wait for Ready
    Destination-->>-Source:[Ready]
    Source->>Destination: [Data]
    activate Destination
    Source-->>Destination: [Valid]
    Source-->>+Destination: Ack?
    note right of Destination: Wait for Ack
    Destination-->>-Source: [Ack]
    deactivate Destination
    Source-->>Destination: not [Valid]
  end
</div>

1. まずSource側に流せるデータが有るなら、DestinationからReadyが出るまで待機
2. Readyが出ていたら、SourceからDataとValidを送る
3. DestinationはDataとValidを受信したらAckを立てる
4. SourceはDataとValidを引っ込めて、まだ流せるデータが有るなら1.に戻る

波形で示すならこう。AckとReadyの機能がかぶっているようにしか見えないが今回はこのような仕様ということで勘弁して欲しい。

<script type="WaveDrom">
{signal: [
  {name: 'clk', wave: 'p........|....'},
  {name: 'reset', wave: '01.......|....'},
  {},
  {name: 'dst_ready', wave: '0.1......|..0.'},
  {name: 'src_data', wave: 'xxx2.x2.x|2.x.'},
  {name: 'src_valid', wave: '0..1.01.0|1.0.'},
  {name: 'dst_ack', wave: '0...10.10|.10.'},
]}
</script>

### データの格納方式

C++などでも標準ライブラリとなっているFIFO(Queue)だが、組み込み環境で一番簡単な実装はリングバッファである。

大きめの配列と読み込み用のポインタ、書き込み用のポインタを用意する。書き込み時には書き込みポインタに値を書いたらポインタを進める、読み込みも同様。ただしポインタが配列の最後まで来たら先頭に戻す処理をする。

これについてはデータ構造とアルゴリズム周りの資料に記載されていると思うので、c++等での実装は割愛する。

重要なのは追加された要素の数が配列のサイズを超えない限りは問題なく動作するので、オーバーフローしないように先のインターフェースで正しくステータスを通知するようにする。





準備中
[次回 - ChiselでBF処理系を作る(4)](https://kamiyaowl.github.io/blog/chisel-bf-4/)
